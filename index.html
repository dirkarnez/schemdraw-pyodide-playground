<!doctype html>
<html>
  <head>
      <link
        rel="stylesheet"
        href="https://fred-wang.github.io/MathFonts/LatinModern/mathfonts.css" />
      <script src="https://fred-wang.github.io/mathjax.js/mpadded-min.js"></script>
      <script src="https://cdn.jsdelivr.net/pyodide/v0.29.0/full/pyodide.js"></script>
      <style>
          textarea {
              width: 100%;
          }
      </style>
  </head>
  <body>
    <a href="https://github.com/dirkarnez/schemdraw-pyodide-playground">dirkarnez/schemdraw-pyodide-playground</a><br>
    Pyodide test page<br>
    Open your browser console to see Pyodide output
 	  <textarea id="textarea_input" rows="20" placeholder="Once upon a time..."></textarea>
    <br>
    <button id="btn_ac_circuit_sample">AC circuit sample</button>
    <button id="btn_combinations_sample">Combinations sample</button>
    <button id="btn_submit">Submit</button>
    <br>
    <div id="console_output"></div>
    <script type="text/javascript">
      (() => {
		// Detecting data URLs
		// data URI - MDN https://developer.mozilla.org/en-US/docs/data_URIs
		// The "data" URL scheme: http://tools.ietf.org/html/rfc2397
		// Valid URL Characters: http://tools.ietf.org/html/rfc2396#section2
		// [Detect if a string is a data URL. Doesn't try to parse it or determine validity, just a quick check if a string appears to be a data URL. See http://jsfiddle.net/bgrins/aZWTB/ for a demo.](https://gist.github.com/bgrins/6194623)
		function isDataURL(s) {
		    return !!s.match(/^\s*data:([a-z]+\/[a-z]+(;[a-z\-]+\=[a-z\-]+)?)?(;base64)?,[a-z0-9\!\$\&\'\,\(\)\*\+\,\;\=\-\.\_\~\:\@\/\?\%\s]*\s*$/i);
		}
		  
        const worker = new Worker('worker.js');
        worker.onmessage = function(e) {
			if (isDataURL(e.data)) {
				const newImage = document.createElement('img');
				newImage.src = e.data;
				newImage.width = 500;
				consoleOutput.appendChild(newImage);
				consoleOutput.innerHTML += `<br>`;
			} else {
				consoleOutput.innerHTML += `${e.data}<br>`;
			}
        }
        
        const consoleOutput = document.getElementById("console_output");
        const textareaInput = document.getElementById("textarea_input");
        
        consoleOutput.innerHTML = "";
        
        textareaInput.value = `import matplotlib
import matplotlib.pyplot

import base64
import os
os.environ["MPLBACKEND"] = "AGG"
from io import BytesIO

def show(*, block=None):
	buf = BytesIO()
	matplotlib.pyplot.savefig(buf, format="png")
	buf.seek(0)
	# encode to a base64 str
	img_str = base64.b64encode(buf.read()).decode('utf-8')
	matplotlib.pyplot.clf()
	buf.close()
	print(f"data:image/png;base64,{img_str}")

matplotlib.pyplot.show = show

matplotlib.use('Agg')

import schemdraw
import schemdraw.elements as elm
with schemdraw.Drawing() as d:
    elm.Resistor().label('100KΩ')
    elm.Capacitor().down().label('0.1μF', loc='bottom')
    elm.Line().left()
    elm.Ground()
    elm.SourceV().up().label('10V')

`
      
        document.getElementById("btn_submit").addEventListener("click", function() {
            consoleOutput.innerHTML = "";
            worker.postMessage([ textareaInput.value ]);
        });

        document.getElementById("btn_ac_circuit_sample").addEventListener("click", function() {
           textareaInput.value = `import matplotlib
import matplotlib.pyplot

import base64
import os
os.environ["MPLBACKEND"] = "AGG"
from io import BytesIO

def show(*, block=None):
	buf = BytesIO()
	matplotlib.pyplot.savefig(buf, format="png")
	buf.seek(0)
	# encode to a base64 str
	img_str = base64.b64encode(buf.read()).decode('utf-8')
	matplotlib.pyplot.clf()
	buf.close()
	print(f"data:image/png;base64,{img_str}")

matplotlib.pyplot.show = show

matplotlib.use('Agg')

import schemdraw
import schemdraw.elements as elm
with schemdraw.Drawing() as d:
    d.config(inches_per_unit=.5, unit=3)
    D = elm.Rectifier()
    elm.Line().left(d.unit*1.5).at(D.N).dot(open=True).idot()
    elm.Line().left(d.unit*1.5).at(D.S).dot(open=True).idot()
    G = elm.Gap().toy(D.N).label(['–', 'AC IN', '+'])

    top = elm.Line().right(d.unit*3).at(D.E).idot()
    Q2 = elm.BjtNpn(circle=True).up().anchor('collector').label('Q2\n2n3055')
    elm.Line().down(d.unit/2).at(Q2.base)
    Q2b = elm.Dot()
    elm.Line().left(d.unit/3)
    Q1 = elm.BjtNpn(circle=True).up().anchor('emitter').label('Q1\n    2n3054')
    elm.Line().at(Q1.collector).toy(top.center).dot()

    elm.Line().down(d.unit/2).at(Q1.base).dot()
    elm.Zener().down().reverse().label('D2\n500mA', loc='bot').dot()
    G = elm.Ground()
    elm.Line().left().dot()
    elm.Capacitor(polar=True).up().reverse().label('C2\n100$\\mu$F\n50V', loc='bot').dot()
    elm.Line().right().hold()
    elm.Resistor().toy(top.end).label('R1\n2.2K\n50V', loc='bot').dot()

    d.move(dx=-d.unit, dy=0)
    elm.Capacitor(polar=True).toy(G.start).flip().label('C1\n 1000$\\mu$F\n50V').dot().idot()
    elm.Line().at(G.start).tox(D.W)
    elm.Line().toy(D.W).dot()

    elm.Resistor().right().at(Q2b.center).label('R2').label('56$\\Omega$ 1W', loc='bot').dot()
    with d.hold():
        elm.Line().toy(top.start).dot()
        elm.Line().tox(Q2.emitter)
    elm.Capacitor(polar=True).toy(G.start).label('C3\n470$\\mu$F\n50V', loc='bot').dot()
    elm.Line().tox(G.start).hold()
    elm.Line().right().dot()
    elm.Resistor().toy(top.center).label('R3\n10K\n1W', loc='bot').dot()
    elm.Line().left().hold()
    elm.Line().right()
    elm.Dot(open=True)
    elm.Gap().toy(G.start).label(['+', '$V_{out}$', '–'])
    elm.Dot(open=True)
    elm.Line().left()
`;
        });

        document.getElementById("btn_combinations_sample").addEventListener("click", function() {
           textareaInput.value = `import itertools
print(list(itertools.combinations([1, 2, 3], 2)))

print(list(itertools.combinations("RLC", 2)))
`;
        });
      })()
    </script>
  </body>
</html>
